name: GitHub Admin Tool

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - create-team
          - delete-team
          - add-repo
          - remove-repo
          - add-user
          - remove-user
          - create-repo
          - user-access

      org:
        description: 'GitHub Organization'
        required: true
        type: choice
        options:
          - new-organization97
          - example-org
          - another-org

      team:
        description: 'Team name (if applicable)'
        required: false

      repo:
        description: 'Repository name (if applicable)'
        required: true
        

      user: 
        description: 'GitHub username (not email!)'
        required: false


      permission:
        description: 'Permission level (if applicable)'
        required: false
        type: choice
        options:
          - nil
          - pull
          - triage
          - push
          - maintain
          - admin

      repo_name:
        description: 'New repo name (for create-repo)'
        required: false

      repo_private:
        description: 'Should repo be private?'
        required: false
        type: choice
        options:
          - "false"
          - "true"

jobs:
  github-admin:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt || true

      - name: Run GitHub Admin Script
        env:
          TOKEN: ${{ secrets.TOKEN }}
          ACTION: ${{ github.event.inputs.action }}
          ORG: ${{ github.event.inputs.org }}
          TEAM: ${{ github.event.inputs.team }}
          USER: ${{ github.event.inputs.user }}
          REPO: ${{ github.event.inputs.repo }}          
          PERMISSION: ${{ github.event.inputs.permission }}
          REPO_NAME: ${{ github.event.inputs.repo_name }}
          REPO_PRIVATE: ${{ github.event.inputs.repo_private }}
          
        run: |
          ARGS="--action \"$ACTION\" --org \"$ORG\""

          [[ -n "$TEAM" ]] && ARGS="$ARGS --team \"$TEAM\""
          [[ -n "$REPO" ]] && ARGS="$ARGS --repo \"$REPO\""
          [[ -n "$USER" ]] && ARGS="$ARGS --user \"$USER\""
          [[ "$PERMISSION" != "nil" && -n "$PERMISSION" ]] && ARGS="$ARGS --permission \"$PERMISSION\""
          [[ -n "$REPO_NAME" ]] && ARGS="$ARGS --repo-name \"$REPO_NAME\""
          [[ "$REPO_PRIVATE" == "true" ]] && ARGS="$ARGS --repo-private"

          echo "‚ñ∂ Running script: python3 scripts/github_admin.py $ARGS"
          eval python3 git-manager.py $ARGS

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Install and Run Gitleaks 
        run: |
          echo "‚¨áÔ∏è Fetching latest Gitleaks release tag..."
          LATEST=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r '.tag_name')

          VERSION=${LATEST#v}
    
          echo "üì• Downloading Gitleaks $LATEST..."
          wget -q "https://github.com/gitleaks/gitleaks/releases/download/$LATEST/gitleaks_${VERSION}_linux_x64.tar.gz" -O gitleaks.tar.gz

          echo "üì¶ Extracting..."
          tar -xzf gitleaks.tar.gz

          chmod +x gitleaks
          sudo mv gitleaks /usr/local/bin/

          echo "üîç Running Gitleaks scan..."
          gitleaks detect --source . --no-banner --verbose --redact

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install wget apt-transport-https gnupg lsb-release -y
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy -y

      - name: Run Trivy vulnerability scan
        run: |
          echo "üîç Running Trivy Filesystem Scan for vulnerabilities..."
          trivy fs --severity HIGH,CRITICAL --exit-code 1 .

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}







